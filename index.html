<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>LogiWaze</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin="" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" crossorigin="" />
</head>
<body style="background: black">
    <div id="mapid" style="height: 100%; background: black;"></div>

    <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js" integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og==" crossorigin=""></script>
    <style type="text/css">

        .leaflet-routing-alt-minimized .detailed-routeinfo {
            display: none;
        }

        .leaflet-routing-alt-minimized .summary-routeinfo {
            display: inline !important;
        }
    </style>

    <script type="text/javascript">

        var mymap = L.map('mapid',
            {
                crs: L.CRS.Simple,
                maxBounds: L.latLngBounds(L.latLng(-256, 0), L.latLng(0, 256)),
                noWrap: true,
                continuousWorld: true,
                bounds: L.latLngBounds(L.latLng(-256, 0), L.latLng(0, 256))
            }).setView([0, 0], 2);

        var SatelliteMap = L.tileLayer('Sat Tiles/{z}/{z}_{x}_{y}.webp',
            {
                crs: L.CRS.Simple,
                maxZoom: 5,
                minZoom: 1,
                noWrap: true,
                continuousWorld: true,
                bounds: L.latLngBounds(L.latLng(-256, 0), L.latLng(0, 256)),
                id: 'LogiWaze'
             });
        SatelliteMap.addTo(mymap);


        var DrawnMap = L.tileLayer('Tiles/{z}/{z}_{x}_{y}.webp',
            {
                crs: L.CRS.Simple,
                maxZoom: 5,
                minZoom: 1,
                noWrap: true,
                continuousWorld: true,
                bounds: L.latLngBounds(L.latLng(-256, 0), L.latLng(0, 256)),
                id: 'LogiWaze'
            });
        DrawnMap.addTo(mymap);

    </script>

    <script src="FoxholeRouter.js">
    </script>


    <script type="text/javascript">
        var APIManager = API.Create();

        APIManager.update(() => {

            var Router = FoxholeRouter.Create(mymap, APIManager);
            var Geocoder = FoxholeGeocoder.Create();



            L.control.layers(
                {
                    'Map View': DrawnMap,
                    'Satellite View': SatelliteMap
                }, {
                'Borders': Router.Borders,
                'Roads': Router.RoadsCanvas,
            }, { position: 'topright' }).addTo(mymap);

            var startingWaypoints = [
                L.latLng(-148.2358, 192.46460000000002),
                L.latLng(-151.9339, 191.6564)
            ];

            Router.Borders.setStyle(
                {
                    color: "#303030",
                    opacity: '0.5',
                    dashArray: '5, 10'
                }
            );

            Router.Roads.setStyle({ color: 'purple' });

            class custom_formatter extends L.Routing.ItineraryBuilder {
                constructor() {
                    super();
                    this.index = 0;
                }

                createStep(text, distance, steps) {
                    var container = document.createElement("TR");
                    var divider1 = document.createElement("TD");
                    var divider2 = document.createElement("TD");
                    var divider3 = document.createElement("TD");

                    divider1.innerText = distance.concat(" ").concat(text);
                    divider1.style = "font-size: x-small";
                    container.appendChild(divider1);
                    container.appendChild(divider2);
                    container.appendChild(divider3);
                    container.index = this.index++;
                    //this.block.appendChild(container);
                    return container;
                }

                createContainer(className) {
                    this.container = L.Routing.ItineraryBuilder.prototype.createContainer(className);
                    return this.container;
                }

                createStepsContainer(container) {
                    this.block = L.Routing.ItineraryBuilder.prototype.createStepsContainer(container);
                    this.container.appendChild(this.block);
                    return this.block;
                }
            }

            class custom_time_formatter extends L.Routing.Formatter {
                formatTime(t) {
                    var t1 = L.Routing.Formatter.prototype.formatTime.call(this, t);
                    var t2 = L.Routing.Formatter.prototype.formatTime.call(this, t * 1.4);
                    return "<td><div class=\'detailed-routeinfo\'><img src=\'HeavyTruck.png\' style=\'width: 32px; height: 32px; vertical-align: middle; filter: brightness(0%);\' />".concat(t1).concat("</div></td></tr><tr><td><div class=\'detailed-routeinfo\'><img src=\'HeavyTruck.png\' style=\'width: 32px; height: 32px; vertical-align: middle; filter: brightness(70%) sepia(50) saturate(70);\' />").concat(t2).concat("</div></td>");
                }

            }

            var form = new custom_formatter();

            Router.Control = L.Routing.control(
                {
                    showAlternatives: false,
                    reverseWaypoints: true,
                    maxGeocoderTolerance: 1000000,
                    routeWhileDragging: false,
                    router: Router,
                    autoRoute: true,
                    geocoder: Geocoder,
                    routeLine: function (route, options) {
                        if (route.name == "Shortest Route")
                            return L.Routing.line(route, {
                                addWaypoints: options.addWaypoints, styles: [
                                    { color: 'black', opacity: 0.15, weight: 9 }, { color: 'white', opacity: 0.8, weight: 6 }, { color: '#9E3031', opacity: 1, weight: 2 }
                                ]
                            });
                        return L.Routing.line(route, {
                            addWaypoints: options.addWaypoints, styles: [
                                { color: 'black', opacity: 0.15, weight: 9 }, { color: 'white', opacity: 0.8, weight: 6 }, { color: '#5E9339', opacity: 1, weight: 2 }
                            ]
                        });
                    },
                    fitSelectedRoutes: false,
                    itineraryBuilder: form,
                    summaryTemplate: '<table style=\'border: 0; width: 100%; pointer-events: none;\'><tr><td colspan=\'2\'>{name}<span style=\'margin-left: 1em; display: none\' class=\'summary-routeinfo\'>{distance}</span></td></tr><tr><td rowspan=\'2\' style=\'text-align: center; padding: 4px;\'><span class=\'detailed-routeinfo\'>{distance}</span></td>{time}</tr></table>',
                    formatter: new custom_time_formatter
                }
            ).addTo(mymap).on('waypointschanged', function (event) {
                var l = "";
                for (var i = 0; i < event.waypoints.length; i++) {
                    if (i > 0)
                        l = l.concat("|");
                    l = l.concat(event.waypoints[i].latLng.lat.toFixed(4)).concat(",").concat(event.waypoints[i].latLng.lng.toFixed(4));
                }
                location.hash = l;
            });

            // load initial waypoints
            var points = startingWaypoints;
            if (typeof (location.hash) != 'undefined' && location.hash != "" && location.hash != "#") {
                var h = decodeURI(location.hash.substr(1));
                var l = h.split("|");
                points = [];
                for (var i = 0; i < l.length; i++) {
                    var a = l[i].split(",");
                    points.push([parseFloat(a[0]), parseFloat(a[1])]);
                }
            }

            Router.Control.setWaypoints(points);
        });


    </script>
</body>
</html>
